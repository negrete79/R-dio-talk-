<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¢mera com QR Code</title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #1a1a1a; color: #f0f0f0; text-align: center; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; box-sizing: border-box; }
        h1 { color: #4fc3f7; margin-bottom: 10px; }
        .subtitle { color: #aaa; margin-bottom: 20px; }
        #video { width: 100%; max-width: 400px; border-radius: 12px; background: #000; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        .qr-container { margin: 20px 0; padding: 20px; background: #fff; border-radius: 12px; display: inline-block; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        #qrcode { padding: 10px; background: white; }
        #status { margin-top: 20px; font-size: 18px; color: #4fc3f7; font-weight: bold; }
        .instructions { background: #333; padding: 15px; border-radius: 8px; margin-top: 20px; max-width: 400px; }
        .wake-lock-btn { background: #ff9800; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 15px; }
        .wake-lock-btn:disabled { background: #555; cursor: not-allowed; }
        .warning { background: #d32f2f; color: white; padding: 10px; border-radius: 8px; margin-top: 15px; }
    </style>
</head>
<body>
    <h1>üìπ C√¢mera de Vigil√¢ncia</h1>
    <p class="subtitle">Escaneie este QR Code com o app do espectador</p>

    <video id="video" autoplay muted playsinline></video>
    
    <div class="qr-container">
        <div id="qrcode"></div>
    </div>

    <div id="status">Gerando QR Code...</div>
    <button id="wakeLockBtn" class="wake-lock-btn">Manter Tela Ativa</button>
    
    <div class="instructions">
        <strong>Instru√ß√µes:</strong><br>
        1. Permita o acesso √† c√¢mera.<br>
        2. Clique em "Manter Tela Ativa".<br>
        3. <strong>N√ÉO feche esta p√°gina nem apague a tela.</strong><br>
        4. Para melhorar, v√° em Config. > Bateria > e desative a "Otimiza√ß√£o de Bateria" para este navegador.
    </div>
    <div class="warning">
        <strong>Aten√ß√£o:</strong> Este √© um site. Para funcionar 24/7, ele precisa ficar aberto na tela.
    </div>

    <script>
        const video = document.getElementById('video');
        const statusDiv = document.getElementById('status');
        const qrcodeDiv = document.getElementById('qrcode');
        const wakeLockBtn = document.getElementById('wakeLockBtn');
        
        let localStream;
        let peer;
        let wakeLock = null;
        const cameraId = 'cam-' + Math.random().toString(36).substr(2, 9);

        // Fun√ß√£o para manter a tela ativa
        async function requestWakeLock() {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                statusDiv.textContent = 'Tela ativa! Pronto para conex√£o.';
                wakeLockBtn.textContent = 'Tela Ativa (OK)';
                wakeLockBtn.disabled = true;

                wakeLock.addEventListener('release', () => {
                    statusDiv.textContent = 'A tela foi desbloqueada. O app pode parar.';
                    wakeLockBtn.textContent = 'Manter Tela Ativa';
                    wakeLockBtn.disabled = false;
                });

            } catch (err) {
                console.error(`Falha ao ativar Wake Lock: ${err.name}, ${err.message}`);
                statusDiv.textContent = `N√£o foi poss√≠vel manter a tela ativa: ${err.message}`;
            }
        }

        wakeLockBtn.addEventListener('click', requestWakeLock);

        // O resto do c√≥digo √© o mesmo...
        async function init() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
                video.srcObject = localStream;

                peer = new Peer(cameraId);
                
                peer.on('open', (id) => {
                    new QRCode(qrcodeDiv, { text: id, width: 200, height: 200 });
                    statusDiv.textContent = 'Pronto! Clique em "Manter Tela Ativa".';
                });

                peer.on('call', (call) => {
                    statusDiv.textContent = 'Espectador conectado!';
                    call.answer(localStream);
                });

                peer.on('disconnected', () => {
                    statusDiv.textContent = 'Espectador desconectado. Aguardando nova conex√£o...';
                });

                peer.on('error', (err) => {
                    console.error(err);
                    statusDiv.textContent = `Erro: ${err.type}`;
                });

            } catch (err) {
                console.error("Erro ao inicializar:", err);
                statusDiv.textContent = 'Erro: Verifique as permiss√µes da c√¢mera.';
            }
        }

        init();
    </script>
</body>
</html>