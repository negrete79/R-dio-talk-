<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transmissor - C√¢mera Remota</title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #1a1a1a; color: #f0f0f0; text-align: center; padding: 20px; margin: 0; }
        #container { max-width: 800px; margin: auto; background: #2a2a2a; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h1 { color: #4CAF50; }
        #id-display { font-size: 18px; word-break: break-all; background: #333; padding: 10px; border-radius: 5px; margin: 10px 0; }
        #qrcode { margin: 20px auto; width: 256px; height: 256px; padding: 20px; background: white; border-radius: 10px; display: inline-block; }
        #status { font-size: 18px; margin: 20px 0; color: #ccc; }
        #local-video { 
            width: 100%; 
            max-width: 640px; 
            height: auto; 
            background: #000; 
            border-radius: 10px; 
            margin-top: 20px; 
            display: none; /* Escondido at√© a c√¢mera ligar */
            transform: scaleX(-1); /* Espelha para o usu√°rio */
        }
        .controls { margin-top: 20px; }
        button { 
            padding: 15px 25px; 
            font-size: 18px; 
            border: none; 
            border-radius: 50px; 
            cursor: pointer; 
            background: #ff9800; 
            color: white; 
            transition: background 0.3s, transform 0.1s;
            margin: 0 5px;
        }
        button:active { transform: scale(0.95); }
        button:disabled { background: #555; cursor: not-allowed; }
        #start-camera-btn { background: #4CAF50; }
    </style>
</head>
<body>
    <div id="container">
        <h1>üì° Transmissor de C√¢mera</h1>
        <p>Um espectador pode se conectar escaneando o QR Code abaixo.</p>
        
        <button id="start-camera-btn">1. Iniciar C√¢mera</button>
        
        <div id="id-display" style="display:none;">ID: ...</div>
        <div id="qrcode" style="display:none;"></div>
        
        <div id="status">Clique em "Iniciar C√¢mera" para come√ßar.</div>
        
        <!-- Pr√©via da pr√≥pria c√¢mera do transmissor -->
        <video id="local-video" autoplay muted playsinline></video>
        
        <div class="controls" id="flash-controls" style="display:none;">
            <button id="flash-btn">üî¶ Flash</button>
        </div>
    </div>

    <script>
        const startCameraBtn = document.getElementById('start-camera-btn');
        const idDisplay = document.getElementById('id-display');
        const statusDiv = document.getElementById('status');
        const qrcodeDiv = document.getElementById('qrcode');
        const localVideo = document.getElementById('local-video');
        const flashBtn = document.getElementById('flash-btn');
        const flashControls = document.getElementById('flash-controls');

        let peer = null;
        let localStream = null;
        let videoTrack = null;
        let isFlashOn = false;

        startCameraBtn.onclick = startCameraAndPeer;
        flashBtn.onclick = toggleFlash;

        async function startCameraAndPeer() {
            startCameraBtn.disabled = true;
            statusDiv.textContent = 'Acessando a c√¢mera traseira...';
            
            try {
                // Pede acesso √† c√¢mera traseira ('environment') e ao microfone
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }, 
                    audio: true 
                });
                
                localVideo.srcObject = localStream;
                localVideo.style.display = 'block';
                videoTrack = localStream.getVideoTracks()[0];

                // Verifica se o flash (torch) est√° dispon√≠vel
                const capabilities = videoTrack.getCapabilities();
                if (capabilities.torch) {
                    flashControls.style.display = 'block';
                } else {
                    console.log('Flash (torch) n√£o dispon√≠vel neste dispositivo.');
                }

                statusDiv.textContent = 'C√¢mera OK. Iniciando conex√£o...';
                
                // Inicia o Peer
                peer = new Peer();

                peer.on('open', (id) => {
                    console.log('Meu ID de peer √©: ' + id);
                    idDisplay.style.display = 'block';
                    idDisplay.textContent = `ID: ${id}`;
                    qrcodeDiv.style.display = 'inline-block';
                    
                    new QRCode(qrcodeDiv, {
                        text: id,
                        width: 256,
                        height: 256,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                    
                    statusDiv.textContent = 'Pronto! Aguardando um espectador se conectar...';
                });

                peer.on('connection', (conn) => {
                    console.log('Conex√£o de dados recebida de:', conn.peer);
                });

                // Escuta por chamadas de m√≠dia
                peer.on('call', (call) => {
                    statusDiv.textContent = `‚è≥ Espectador ${call.peer} est√° conectando...`;
                    console.log('Recebendo chamada de: ' + call.peer);
                    
                    // Responde √† chamada enviando nosso stream (c√¢mera/mic)
                    call.answer(localStream);

                    call.on('close', () => {
                        statusDiv.textContent = 'Espectador desconectado. Aguardando nova conex√£o...';
                    });

                    call.on('error', (err) => {
                        statusDiv.textContent = `‚ùå Erro na chamada: ${err.message}`;
                        console.error('Erro na chamada:', err);
                    });
                });

                peer.on('error', (err) => {
                    statusDiv.textContent = `‚ùå Erro no Peer: ${err.type}`;
                    console.error('Erro no Peer:', err);
                });

            } catch (err) {
                statusDiv.textContent = `‚ùå Erro ao acessar a c√¢mera: ${err.message}`;
                console.error(err);
                startCameraBtn.disabled = false;
            }
        }
        
        async function toggleFlash() {
            if (!videoTrack) return;
            try {
                isFlashOn = !isFlashOn;
                await videoTrack.applyConstraints({
                    advanced: [{ torch: isFlashOn }]
                });
                flashBtn.textContent = isFlashOn ? 'üî¶ Flash: ON' : 'üî¶ Flash: OFF';
            } catch (err) {
                console.error('Erro ao controlar o flash:', err);
                flashBtn.disabled = true;
            }
        }
    </script>
</body>
</html>