<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transmissor - Intercomunicador</title>
    <!-- Biblioteca PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <!-- Biblioteca para gerar QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #1a1a1a; color: #f0f0f0; text-align: center; padding: 20px; margin: 0; }
        h1 { color: #4CAF50; }
        #container { max-width: 800px; margin: auto; background: #2a2a2a; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #id-display { font-size: 18px; word-break: break-all; background: #333; padding: 10px; border-radius: 5px; margin: 10px 0; }
        #qrcode { margin: 20px auto; width: 256px; height: 256px; padding: 20px; background: white; border-radius: 10px; display: inline-block; }
        #status { font-size: 18px; margin: 20px 0; color: #ccc; }
        #remote-video { 
            width: 100%; 
            max-width: 640px; 
            height: auto; 
            background: #000; 
            border-radius: 10px; 
            margin-top: 20px; 
            display: none; /* Escondido at√© a conex√£o */
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>üì° Transmissor</h1>
        <p>Escaneie este QR Code com o dispositivo do Espectador para conectar.</p>
        
        <div id="id-display">Gerando ID...</div>
        
        <div id="qrcode"></div>
        
        <div id="status">Aguardando conex√£o...</div>
        
        <!-- V√≠deo do espectador ser√° exibido aqui -->
        <video id="remote-video" autoplay playsinline></video>
    </div>

    <script>
        const idDisplay = document.getElementById('id-display');
        const statusDiv = document.getElementById('status');
        const qrcodeDiv = document.getElementById('qrcode');
        const remoteVideo = document.getElementById('remote-video');

        // Inicializa o Peer. O ID ser√° gerado automaticamente.
        const peer = new Peer();

        peer.on('open', (id) => {
            console.log('Meu ID de peer √©: ' + id);
            idDisplay.textContent = `ID: ${id}`;
            
            // Gera o QR Code com o ID
            new QRCode(qrcodeDiv, {
                text: id,
                width: 256,
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            
            statusDiv.textContent = 'Pronto para receber uma conex√£o.';
        });

        // Escuta por chamadas de m√≠dia (v√≠deo e √°udio)
        peer.on('call', (call) => {
            statusDiv.textContent = `Recebendo chamada de ${call.peer}...`;
            
            // Responde √† chamada, sem enviar nosso pr√≥prio stream
            call.answer();

            // Quando o stream do espectador chegar, exiba no v√≠deo
            call.on('stream', (remoteStream) => {
                console.log('Stream recebido.');
                statusDiv.textContent = `‚úÖ Conectado com ${call.peer}. Recebendo √°udio e v√≠deo.`;
                remoteVideo.srcObject = remoteStream;
                remoteVideo.style.display = 'block'; // Mostra o v√≠deo
            });

            call.on('close', () => {
                statusDiv.textContent = '‚ùå Conex√£o encerrada.';
                remoteVideo.style.display = 'none';
                remoteVideo.srcObject = null;
            });

            call.on('error', (err) => {
                statusDiv.textContent = `‚ùå Erro na chamada: ${err.message}`;
                console.error('Erro na chamada:', err);
            });
        });

        peer.on('error', (err) => {
            statusDiv.textContent = `‚ùå Erro no Peer: ${err.type}`;
            console.error('Erro no Peer:', err);
        });
    </script>
</body>
</html>