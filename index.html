<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iMo - Videochamada Simples</title>
    <meta name="description" content="Uma PWA de videochamada simples e r√°pida.">
    
    <!-- Manifest e Tema -->
    <link rel="manifest" id="app-manifest">
    <meta name="theme-color" content="#f0f2f5">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìπ</text></svg>">

    <!-- Script do PeerJS via CDN -->
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>

    <style>
        /* --- Vari√°veis de Cor e Estilo Geral --- */
        :root {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --text-primary: #1c1e21;
            --text-secondary: #65676b;
            --border-color: #dddfe2;
            --accent-color: #0084ff;
            --accent-hover: #0077e6;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* --- Layout Principal --- */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* --- Sidebar (Lista de Contatos) --- */
        .sidebar {
            width: 350px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .sidebar-header h2 {
            font-size: 24px;
            font-weight: 600;
        }

        .my-peer-id {
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            word-break: break-all;
        }

        .add-contact-form {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .add-contact-form input {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 14px;
        }

        .add-contact-form button {
            padding: 10px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .add-contact-form button:hover {
            background-color: var(--accent-hover);
        }

        /* --- Lista de Contatos com Barra de Rolagem --- */
        .contacts-list {
            flex-grow: 1;
            overflow-y: auto; /* Garante a barra de rolagem */
            padding: 10px;
        }

        /* Estiliza√ß√£o da barra de rolagem para WebKit/Blink */
        .contacts-list::-webkit-scrollbar {
            width: 6px;
        }

        .contacts-list::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        .contacts-list::-webkit-scrollbar-thumb {
            background-color: var(--text-secondary);
            border-radius: 3px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .contact-item:hover {
            background-color: var(--bg-primary);
        }

        .contact-avatar {
            width: 40px;
            height: 40px;
            background-color: #e4e6eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 20px;
        }

        .contact-info h3 {
            font-size: 16px;
            font-weight: 500;
        }

        .contact-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* --- √Årea de Conte√∫do Principal --- */
        .main-content {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .welcome-message h1 {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .welcome-message p {
            font-size: 18px;
            color: var(--text-secondary);
        }

        /* --- Tela de Chamada Ativa --- */
        .call-screen {
            display: none;
            position: relative;
            width: 100%;
            height: 100%;
            background-color: black;
        }

        #remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #local-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            background-color: #333;
            border-radius: var(--radius);
            border: 2px solid var(--bg-secondary);
            object-fit: cover;
            box-shadow: var(--shadow);
        }

        .call-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 30px;
        }

        .call-controls button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        .call-controls button:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .call-controls button.end-call {
            background-color: #fa383e;
        }

        .call-controls button.end-call:hover {
            background-color: #d32f2f;
        }
        
        .call-controls button.muted {
            background-color: #fa383e;
        }

        /* --- Modal de Chamada Recebida --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            padding: 30px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: var(--shadow);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content h2 {
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-buttons button {
            padding: 12px 25px;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .modal-buttons .accept {
            background-color: #31a24c;
            color: white;
        }

        .modal-buttons .accept:hover {
            background-color: #2e8b44;
        }

        .modal-buttons .decline {
            background-color: #fa383e;
            color: white;
        }

        .modal-buttons .decline:hover {
            background-color: #d32f2f;
        }

        /* --- Responsividade --- */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                width: 100%;
            }
            .welcome-message h1 { font-size: 32px; }
            #local-video { width: 100px; height: 75px; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <header class="sidebar-header">
                <h2>üìπ iMo</h2>
                <div class="my-peer-id">Seu ID: <span id="my-id">...</span></div>
            </header>
            <form class="add-contact-form" id="add-contact-form">
                <input type="text" id="contact-name" placeholder="Nome do Contato" required>
                <input type="text" id="contact-peer-id" placeholder="ID do PeerJS" required>
                <button type="submit">Adicionar Contato</button>
            </form>
            <div class="contacts-list" id="contacts-list">
                <!-- Contatos ser√£o inseridos aqui pelo JS -->
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <div class="welcome-message">
                <h1>Bem-vindo ao iMo</h1>
                <p>Adicione um contato para iniciar uma videochamada.</p>
            </div>
        </main>
    </div>

    <!-- Tela de Chamada Ativa (inicialmente escondida) -->
    <div class="call-screen" id="call-screen">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div class="call-controls">
            <button id="mic-toggle" title="Mutar/Desmutar">üé§</button>
            <button id="camera-toggle" title="Ligar/Desligar C√¢mera">üì∑</button>
            <button id="end-call" class="end-call" title="Encerrar Chamada">üìû</button>
        </div>
    </div>

    <!-- Modal de Chamada Recebida -->
    <div class="modal" id="incoming-call-modal">
        <div class="modal-content">
            <h2>üìû Chamada de <span id="caller-name">...</span></h2>
            <div class="modal-buttons">
                <button class="accept" id="accept-call">Atender</button>
                <button class="decline" id="decline-call">Recusar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- L√≥gica da Aplica√ß√£o ---

        class VideoCallApp {
            constructor() {
                this.peer = null;
                this.currentCall = null;
                this.localStream = null;
                this.contacts = [];
                
                this.initElements();
                this.initEventListeners();
                this.loadContacts();
                this.initPWA();
                this.initPeer();
            }

            initElements() {
                // Formul√°rio e lista de contatos
                this.addContactForm = document.getElementById('add-contact-form');
                this.contactNameInput = document.getElementById('contact-name');
                this.contactPeerIdInput = document.getElementById('contact-peer-id');
                this.contactsList = document.getElementById('contacts-list');
                this.myIdSpan = document.getElementById('my-id');

                // Conte√∫do principal e tela de chamada
                this.mainContent = document.getElementById('main-content');
                this.callScreen = document.getElementById('call-screen');
                this.localVideo = document.getElementById('local-video');
                this.remoteVideo = document.getElementById('remote-video');
                
                // Controles da chamada
                this.micToggleBtn = document.getElementById('mic-toggle');
                this.cameraToggleBtn = document.getElementById('camera-toggle');
                this.endCallBtn = document.getElementById('end-call');

                // Modal de chamada recebida
                this.incomingCallModal = document.getElementById('incoming-call-modal');
                this.callerNameSpan = document.getElementById('caller-name');
                this.acceptCallBtn = document.getElementById('accept-call');
                this.declineCallBtn = document.getElementById('decline-call');
            }

            initEventListeners() {
                this.addContactForm.addEventListener('submit', (e) => this.handleAddContact(e));
                this.endCallBtn.addEventListener('click', () => this.endCall());
                this.micToggleBtn.addEventListener('click', () => this.toggleMic());
                this.cameraToggleBtn.addEventListener('click', () => this.toggleCamera());
            }

            // --- PWA ---
            initPWA() {
                // 1. Criar o Manifest
                const manifest = {
                    name: "iMo - Videochamada Simples",
                    short_name: "iMo",
                    start_url: ".",
                    display: "standalone",
                    background_color: "#f0f2f5",
                    theme_color: "#f0f2f5",
                    icons: [
                        { src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìπ</text></svg>", sizes: "any", type: "image/svg+xml" }
                    ]
                };
                const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                const manifestURL = URL.createObjectURL(manifestBlob);
                document.getElementById('app-manifest').href = manifestURL;

                // 2. CORRE√á√ÉO FINAL: Tentar registrar o SW, mas falhar silenciosamente se for bloqueado pelo navegador.
                if ('serviceWorker' in navigator) {
                    const swContent = `
                        self.addEventListener('install', () => self.skipWaiting());
                        self.addEventListener('activate', () => self.clients.claim());
                    `;
                    const swBlob = new Blob([swContent], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(swBlob);

                    navigator.serviceWorker.register(swUrl).catch(error => {
                        // Erro esperado em muitos ambientes de arquivo √∫nico.
                        // Logamos uma mensagem √∫til no console, mas n√£o interrompemos o app.
                        console.warn(
                            `%c‚ö†Ô∏è Falha ao registrar o Service Worker (isso √© normal para arquivos HTML √∫nicos).`,
                            'color: #FFA500; font-weight: bold;'
                        );
                        console.error(
                            'O navegador bloqueou o registro por pol√≠tica de seguran√ßa (origem blob:).',
                            'O aplicativo continuar√° funcionando normalmente, mas sem cache offline.'
                        );
                    });
                }
            }

            // --- PeerJS ---
            initPeer() {
                this.peer = new Peer(); // Usa o servidor de sinaliza√ß√£o p√∫blico do PeerJS
                
                this.peer.on('open', (id) => {
                    console.log('Meu ID do PeerJS:', id);
                    this.myIdSpan.textContent = id;
                });

                this.peer.on('call', (call) => {
                    console.log('Recebendo chamada de:', call.peer);
                    this.handleIncomingCall(call);
                });

                this.peer.on('error', (err) => {
                    console.error('Erro no PeerJS:', err);
                    alert('Ocorreu um erro de conex√£o. Verifique seu ID ou tente novamente.');
                });
            }

            // --- Gerenciamento de Contatos ---
            handleAddContact(e) {
                e.preventDefault();
                const name = this.contactNameInput.value.trim();
                const peerId = this.contactPeerIdInput.value.trim();

                if (name && peerId) {
                    const contact = { id: Date.now(), name, peerId };
                    this.contacts.push(contact);
                    this.saveContacts();
                    this.renderContacts();
                    this.addContactForm.reset();
                }
            }

            saveContacts() {
                localStorage.setItem('imoContacts', JSON.stringify(this.contacts));
            }

            loadContacts() {
                const saved = localStorage.getItem('imoContacts');
                if (saved) {
                    this.contacts = JSON.parse(saved);
                    this.renderContacts();
                }
            }

            renderContacts() {
                this.contactsList.innerHTML = '';
                this.contacts.forEach(contact => {
                    const item = document.createElement('div');
                    item.className = 'contact-item';
                    item.innerHTML = `
                        <div class="contact-avatar">üë§</div>
                        <div class="contact-info">
                            <h3>${contact.name}</h3>
                            <p>${contact.peerId}</p>
                        </div>
                    `;
                    item.addEventListener('click', () => this.startCall(contact.peerId, contact.name));
                    this.contactsList.appendChild(item);
                });
            }

            // --- Fluxo de Chamada ---
            async startCall(peerId, name) {
                if (this.currentCall) {
                    alert('Voc√™ j√° est√° em uma chamada.');
                    return;
                }
                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    this.localVideo.srcObject = this.localStream;

                    const call = this.peer.call(peerId, this.localStream);
                    this.setupCallEvents(call, name);
                    this.showCallScreen();

                } catch (err) {
                    console.error('Falha ao obter m√≠dia local:', err);
                    alert('N√£o foi poss√≠vel acessar sua c√¢mera/microfone. Verifique as permiss√µes do navegador.');
                }
            }

            handleIncomingCall(call) {
                if (this.currentCall) {
                    call.close();
                    return;
                }
                
                const caller = this.contacts.find(c => c.peerId === call.peer);
                this.callerNameSpan.textContent = caller ? caller.name : call.peer;
                this.incomingCallModal.style.display = 'flex';

                const cleanup = () => {
                    this.incomingCallModal.style.display = 'none';
                    this.acceptCallBtn.removeEventListener('click', onAccept);
                    this.declineCallBtn.removeEventListener('click', onDecline);
                };

                const onAccept = async () => {
                    try {
                        this.localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                        this.localVideo.srcObject = this.localStream;
                        call.answer(this.localStream);
                        this.setupCallEvents(call, this.callerNameSpan.textContent);
                        this.showCallScreen();
                    } catch(err) {
                        console.error('Falha ao obter m√≠dia para aceitar chamada:', err);
                        alert('N√£o foi poss√≠vel aceitar a chamada. Verifique as permiss√µes.');
                        call.close();
                    }
                    cleanup();
                };

                const onDecline = () => {
                    call.close();
                    cleanup();
                };
                
                this.acceptCallBtn.addEventListener('click', onAccept);
                this.declineCallBtn.addEventListener('click', onDecline);
            }

            setupCallEvents(call, remoteName) {
                this.currentCall = call;
                
                call.on('stream', (remoteStream) => {
                    console.log('Recebendo stream de:', remoteName);
                    this.remoteVideo.srcObject = remoteStream;
                });

                call.on('close', () => {
                    console.log('Chamada encerrada pelo outro lado.');
                    this.endCall();
                });

                call.on('error', (err) => {
                    console.error('Erro na chamada:', err);
                    alert('A chamada falhou.');
                    this.endCall();
                });
            }

            showCallScreen() {
                this.mainContent.style.display = 'none';
                this.callScreen.style.display = 'block';
            }

            hideCallScreen() {
                this.callScreen.style.display = 'none';
                this.mainContent.style.display = 'flex';
            }

            endCall() {
                if (this.currentCall) {
                    this.currentCall.close();
                }
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                }
                
                this.currentCall = null;
                this.localStream = null;
                this.localVideo.srcObject = null;
                this.remoteVideo.srcObject = null;

                this.hideCallScreen();
                this.resetControlButtons();
            }

            // --- Controles da Chamada ---
            toggleMic() {
                if (this.localStream) {
                    const audioTrack = this.localStream.getAudioTracks()[0];
                    if (audioTrack) {
                        audioTrack.enabled = !audioTrack.enabled;
                        this.micToggleBtn.textContent = audioTrack.enabled ? 'üé§' : 'üîá';
                        this.micToggleBtn.classList.toggle('muted', !audioTrack.enabled);
                    }
                }
            }

            toggleCamera() {
                if (this.localStream) {
                    const videoTrack = this.localStream.getVideoTracks()[0];
                    if (videoTrack) {
                        videoTrack.enabled = !videoTrack.enabled;
                        this.cameraToggleBtn.textContent = videoTrack.enabled ? 'üì∑' : 'üìµ';
                    }
                }
            }
            
            resetControlButtons() {
                this.micToggleBtn.textContent = 'üé§';
                this.micToggleBtn.classList.remove('muted');
                this.cameraToggleBtn.textContent = 'üì∑';
            }
        }

        // Inicializar a aplica√ß√£o quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', () => {
            new VideoCallApp();
        });
    </script>
</body>
</html>